{
  "version": 3,
  "sources": ["stripe-webhook.ts"],
  "sourcesContent": ["import { VercelRequest, VercelResponse } from '@vercel/node';\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport Stripe from 'stripe';\r\nimport { ZodError } from 'zod';\r\n\r\n// Inline error handling (no external dependencies)\r\nclass APIError extends Error {\r\n  constructor(\r\n    public statusCode: number,\r\n    message: string,\r\n    public code?: string\r\n  ) {\r\n    super(message);\r\n    this.name = 'APIError';\r\n  }\r\n}\r\n\r\nconst setCommonHeaders = (res: VercelResponse) => {\r\n  res.setHeader('Content-Type', 'application/json');\r\n  res.setHeader('Access-Control-Allow-Origin', '*');\r\n  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');\r\n  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');\r\n};\r\n\r\nconst errorHandler = (\r\n  error: unknown,\r\n  req: VercelRequest,\r\n  res: VercelResponse\r\n) => {\r\n  console.error('API Error:', error);\r\n  setCommonHeaders(res);\r\n\r\n  if (req.method === 'OPTIONS') {\r\n    return res.status(204).end();\r\n  }\r\n\r\n  if (error instanceof APIError) {\r\n    return res.status(error.statusCode).json({\r\n      status: 'error',\r\n      error: {\r\n        message: error.message,\r\n        code: error.code,\r\n      },\r\n    });\r\n  }\r\n\r\n  if (error instanceof ZodError) {\r\n    return res.status(400).json({\r\n      status: 'error',\r\n      error: {\r\n        message: 'Validation error',\r\n        code: 'VALIDATION_ERROR',\r\n        details: error.errors,\r\n      },\r\n    });\r\n  }\r\n\r\n  if (error instanceof Error && error.name === 'StripeError') {\r\n    return res.status(400).json({\r\n      status: 'error',\r\n      error: {\r\n        message: error.message,\r\n        code: 'STRIPE_ERROR',\r\n      },\r\n    });\r\n  }\r\n\r\n  return res.status(500).json({\r\n    status: 'error',\r\n    error: {\r\n      message: 'Internal server error',\r\n      code: 'INTERNAL_ERROR',\r\n    },\r\n  });\r\n};\r\n\r\nconst withErrorHandler = (\r\n  handler: (req: VercelRequest, res: VercelResponse) => Promise<void>\r\n) => {\r\n  return async (req: VercelRequest, res: VercelResponse) => {\r\n    try {\r\n      setCommonHeaders(res);\r\n      if (req.method === 'OPTIONS') {\r\n        return res.status(204).end();\r\n      }\r\n      await handler(req, res);\r\n    } catch (error) {\r\n      errorHandler(error, req, res);\r\n    }\r\n  };\r\n};\r\n\r\n// Inline Stripe utilities\r\nconst verifyStripeWebhook = (signature: string, payload: string) => {\r\n  if (!process.env.STRIPE_SECRET_KEY) {\r\n    throw new APIError(500, 'STRIPE_SECRET_KEY is required', 'CONFIG_ERROR');\r\n  }\r\n  if (!process.env.STRIPE_WEBHOOK_SECRET) {\r\n    throw new APIError(500, 'STRIPE_WEBHOOK_SECRET is required', 'CONFIG_ERROR');\r\n  }\r\n\r\n  const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {\r\n    apiVersion: '2025-02-24.acacia',\r\n    typescript: true,\r\n  });\r\n\r\n  try {\r\n    return stripe.webhooks.constructEvent(\r\n      payload,\r\n      signature,\r\n      process.env.STRIPE_WEBHOOK_SECRET!\r\n    );\r\n  } catch (err) {\r\n    throw new APIError(400, 'Invalid webhook signature', 'INVALID_SIGNATURE');\r\n  }\r\n};\r\n\r\nconst getSubscription = async (subscriptionId: string) => {\r\n  if (!process.env.STRIPE_SECRET_KEY) {\r\n    throw new APIError(500, 'STRIPE_SECRET_KEY is required', 'CONFIG_ERROR');\r\n  }\r\n\r\n  const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {\r\n    apiVersion: '2025-02-24.acacia',\r\n    typescript: true,\r\n  });\r\n\r\n  try {\r\n    return await stripe.subscriptions.retrieve(subscriptionId);\r\n  } catch (err) {\r\n    if (err instanceof Stripe.errors.StripeError) {\r\n      throw new APIError(400, err.message, 'STRIPE_ERROR');\r\n    }\r\n    throw err;\r\n  }\r\n};\r\n\r\n// Inline Supabase utilities\r\nconst createRestaurant = async (data: {\r\n  name: string;\r\n  email: string;\r\n  subscription_id: string;\r\n  membership_tier: string;\r\n}) => {\r\n  const supabaseAdmin = createClient(\r\n    process.env.SUPABASE_URL!,\r\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\r\n    {\r\n      auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false,\r\n      },\r\n    }\r\n  );\r\n\r\n  const { data: restaurant, error } = await supabaseAdmin\r\n    .from('restaurants')\r\n    .insert([data])\r\n    .select()\r\n    .single();\r\n\r\n  if (error) {\r\n    throw new APIError(500, 'Failed to create restaurant', 'DATABASE_ERROR');\r\n  }\r\n\r\n  return restaurant;\r\n};\r\n\r\nconst updateRestaurantInvite = async (token: string, data: {\r\n  status: 'accepted' | 'expired' | 'in_progress';\r\n  accepted_at?: string;\r\n}) => {\r\n  const supabaseAdmin = createClient(\r\n    process.env.SUPABASE_URL!,\r\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\r\n    {\r\n      auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false,\r\n      },\r\n    }\r\n  );\r\n\r\n  const { error } = await supabaseAdmin\r\n    .from('restaurant_invitations')\r\n    .update(data)\r\n    .eq('token', token);\r\n\r\n  if (error) {\r\n    throw new APIError(500, 'Failed to update restaurant invitation', 'DATABASE_ERROR');\r\n  }\r\n};\r\n\r\nexport default withErrorHandler(async (req: VercelRequest, res: VercelResponse): Promise<void> => {\r\n  // Create Supabase admin client directly in the API (no external dependencies)\r\n  const supabaseAdmin = createClient(\r\n    process.env.SUPABASE_URL!,\r\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\r\n    {\r\n      auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false\r\n      }\r\n    }\r\n  );\r\n\r\n  if (req.method !== 'POST') {\r\n    throw new APIError(405, 'Method not allowed', 'METHOD_NOT_ALLOWED');\r\n  }\r\n\r\n  const signature = req.headers['stripe-signature'];\r\n  if (!signature || typeof signature !== 'string') {\r\n    throw new APIError(400, 'Missing stripe-signature header', 'MISSING_SIGNATURE');\r\n  }\r\n\r\n  // Verify webhook signature\r\n  const event = verifyStripeWebhook(signature, req.body);\r\n\r\n  // Handle the event\r\n  switch (event.type) {\r\n    case 'checkout.session.completed': {\r\n      const session = event.data.object as Stripe.Checkout.Session;\r\n      \r\n      // Handle business onboarding checkout\r\n      if (session.metadata?.type === 'business_onboarding') {\r\n        if (!session.subscription || !session.metadata?.business_invitation_token) {\r\n          throw new APIError(400, 'Invalid business onboarding session data', 'INVALID_SESSION');\r\n        }\r\n\r\n        // Get subscription details\r\n        const subscription = await getSubscription(session.subscription as string);\r\n\r\n        // Get the business invitation details to create the business\r\n        const { data: inviteData, error: inviteError } = await supabaseAdmin.rpc('validate_business_invitation_token', {\r\n          p_token: session.metadata.business_invitation_token\r\n        });\r\n\r\n        if (inviteError || !inviteData || inviteData.length === 0) {\r\n          throw new APIError(400, 'Invalid business invitation token', 'INVALID_TOKEN');\r\n        }\r\n\r\n        const businessData = inviteData[0];\r\n\r\n        // Create business record\r\n        await createRestaurant({\r\n          name: businessData.business_name,\r\n          email: businessData.business_email,\r\n          subscription_id: subscription.id,\r\n          membership_tier: session.metadata.pricing_tier_key,\r\n        });\r\n\r\n        // Mark business invitation as used\r\n        const { error: markUsedError } = await supabaseAdmin.rpc('mark_business_invitation_used', {\r\n          p_token: session.metadata.business_invitation_token\r\n        });\r\n\r\n        if (markUsedError) {\r\n          console.error('Error marking business invitation as used:', markUsedError);\r\n        }\r\n      } \r\n      // Handle legacy restaurant invitations (backward compatibility)\r\n      else if (session.metadata?.restaurantName) {\r\n        if (!session.subscription) {\r\n          throw new APIError(400, 'Invalid session data', 'INVALID_SESSION');\r\n        }\r\n\r\n        // Get subscription details\r\n        const subscription = await getSubscription(session.subscription as string);\r\n\r\n        // Create restaurant record\r\n        await createRestaurant({\r\n          name: session.metadata.restaurantName,\r\n          email: session.customer_email!,\r\n          subscription_id: subscription.id,\r\n          membership_tier: session.metadata.membershipTier,\r\n        });\r\n\r\n        // Mark invite as accepted\r\n        if (session.metadata.inviteToken) {\r\n          await updateRestaurantInvite(session.metadata.inviteToken, {\r\n            status: 'accepted',\r\n            accepted_at: new Date().toISOString(),\r\n          });\r\n        }\r\n      } \r\n      // Handle customer membership signup\r\n      else if (session.metadata?.type === 'customer_membership') {\r\n        if (!session.subscription || !session.metadata?.business_id || !session.metadata?.tier_id) {\r\n          throw new APIError(400, 'Invalid customer membership session data', 'INVALID_SESSION');\r\n        }\r\n\r\n        // Get subscription details\r\n        const subscription = await getSubscription(session.subscription as string);\r\n\r\n        // Create customer membership record\r\n        const { error: membershipError } = await supabaseAdmin\r\n          .from('customers')\r\n          .insert({\r\n            email: session.metadata.customer_email,\r\n            name: session.metadata.customer_name || null,\r\n            business_id: session.metadata.business_id,\r\n            tier_id: session.metadata.tier_id,\r\n            stripe_customer_id: subscription.customer as string,\r\n            stripe_subscription_id: subscription.id,\r\n            subscription_status: 'active',\r\n            created_at: new Date().toISOString()\r\n          });\r\n\r\n        if (membershipError) {\r\n          console.error('Error creating customer membership:', membershipError);\r\n          throw new APIError(500, 'Failed to create customer membership', 'MEMBERSHIP_CREATION_FAILED');\r\n        }\r\n      } else {\r\n        throw new APIError(400, 'Unknown checkout session type', 'INVALID_SESSION');\r\n      }\r\n\r\n      break;\r\n    }\r\n\r\n    default:\r\n      console.log(`Unhandled event type: ${event.type}`);\r\n  }\r\n\r\n  res.status(200).json({ received: true });\r\n});"],
  "mappings": "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",
  "names": ["Stripe"]
}
