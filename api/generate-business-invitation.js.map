{
  "version": 3,
  "sources": ["generate-business-invitation.ts", "utils/error-handler.ts"],
  "sourcesContent": ["import { VercelRequest, VercelResponse } from '@vercel/node';\nimport { randomUUID } from 'crypto';\nimport { createClient } from '@supabase/supabase-js';\nimport { withErrorHandler, APIError } from './utils/error-handler';\n\nexport default withErrorHandler(async (req: VercelRequest, res: VercelResponse): Promise<void> => {\n  // Create Supabase admin client directly in the API (no external dependencies)\n  const supabaseAdmin = createClient(\n    process.env.SUPABASE_URL!,\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false\n      }\n    }\n  );\n\n  if (req.method !== 'POST') {\n    throw new APIError(405, 'Method not allowed', 'METHOD_NOT_ALLOWED');\n  }\n\n  // Get authorization header\n  const authHeader = req.headers.authorization;\n  if (!authHeader || !authHeader.startsWith('Bearer ')) {\n    throw new APIError(401, 'Missing or invalid authorization header', 'UNAUTHORIZED');\n  }\n\n  const token = authHeader.split(' ')[1];\n  if (!token) {\n    throw new APIError(401, 'Invalid authorization token format', 'UNAUTHORIZED');\n  }\n\n  // Verify the user session\n  const { data: { user }, error: authError } = await supabaseAdmin.auth.getUser(token);\n  \n  if (authError || !user) {\n    console.error('Auth error:', authError);\n    throw new APIError(401, 'Invalid authentication token', 'UNAUTHORIZED');\n  }\n\n  // Check if user is admin by querying the user profile\n  const { data: userProfile, error: profileError } = await supabaseAdmin\n    .from('Users')\n    .select('is_admin')\n    .eq('auth_id', user.id)\n    .single();\n\n  if (profileError || !userProfile || !userProfile.is_admin) {\n    console.error('Admin check failed:', { profileError, userProfile, userId: user.id });\n    throw new APIError(403, 'Only admin users can generate business invitations', 'FORBIDDEN');\n  }\n\n  // Parse request body\n  const { business_name, business_email, pricing_tier } = req.body;\n\n  // Validate required fields\n  if (!business_name || !business_email) {\n    throw new APIError(400, 'Business name and email are required', 'VALIDATION_ERROR');\n  }\n\n  // Validate email format\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  if (!emailRegex.test(business_email)) {\n    throw new APIError(400, 'Invalid email format', 'VALIDATION_ERROR');\n  }\n\n  // Validate pricing tier if provided (should be a UUID)\n  if (pricing_tier) {\n    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\n    if (!uuidRegex.test(pricing_tier)) {\n      throw new APIError(400, 'Invalid pricing tier ID format', 'VALIDATION_ERROR');\n    }\n\n    // Verify the pricing tier exists\n    const { data: tierExists, error: tierError } = await supabaseAdmin\n      .from('business_pricing_tiers')\n      .select('id')\n      .eq('id', pricing_tier)\n      .eq('is_active', true)\n      .single();\n\n    if (tierError || !tierExists) {\n      throw new APIError(400, 'Invalid pricing tier selected', 'VALIDATION_ERROR');\n    }\n  }\n\n  // Generate invitation token and insert into restaurant_invitations\n  const invitationToken = randomUUID();\n  const expiresAt = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000); // 30 days from now\n  \n  const { data, error } = await supabaseAdmin\n    .from('restaurant_invitations')\n    .insert({\n      token: invitationToken,\n      email: business_email,\n      restaurant_name: business_name,\n      tier: pricing_tier || 'standard',\n      expires_at: expiresAt.toISOString(),\n      status: 'pending'\n    })\n    .select('token, expires_at')\n    .single();\n\n  if (error) {\n    console.error('Error generating restaurant invitation:', error);\n    throw new APIError(500, 'Failed to generate restaurant invitation', 'DATABASE_ERROR');\n  }\n\n  if (!data) {\n    throw new APIError(500, 'Failed to generate invitation token', 'DATABASE_ERROR');\n  }\n\n  const invitationData = data;\n  const protocol = req.headers['x-forwarded-proto'] || 'http';\n  const host = req.headers.host;\n  const fullInvitationUrl = `${protocol}://${host}/onboarding/${invitationData.token}`;\n\n  res.status(200).json({\n    success: true,\n    data: {\n      token: invitationData.token,\n      invitation_url: fullInvitationUrl,\n      expires_at: invitationData.expires_at\n    }\n  });\n});", "import { VercelRequest, VercelResponse } from '@vercel/node';\r\nimport { ZodError } from 'zod';\r\n\r\nexport class APIError extends Error {\r\n  constructor(\r\n    public statusCode: number,\r\n    message: string,\r\n    public code?: string\r\n  ) {\r\n    super(message);\r\n    this.name = 'APIError';\r\n  }\r\n}\r\n\r\n// Helper to set common headers for all responses\r\nconst setCommonHeaders = (res: VercelResponse) => {\r\n  res.setHeader('Content-Type', 'application/json');\r\n  res.setHeader('Access-Control-Allow-Origin', '*');\r\n  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');\r\n  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');\r\n};\r\n\r\nexport const errorHandler = (\r\n  error: unknown,\r\n  req: VercelRequest,\r\n  res: VercelResponse\r\n) => {\r\n  console.error('API Error:', error);\r\n  setCommonHeaders(res);\r\n\r\n  // Handle preflight requests\r\n  if (req.method === 'OPTIONS') {\r\n    return res.status(204).end();\r\n  }\r\n\r\n  if (error instanceof APIError) {\r\n    return res.status(error.statusCode).json({\r\n      status: 'error',\r\n      error: {\r\n        message: error.message,\r\n        code: error.code,\r\n      },\r\n    });\r\n  }\r\n\r\n  if (error instanceof ZodError) {\r\n    return res.status(400).json({\r\n      status: 'error',\r\n      error: {\r\n        message: 'Validation error',\r\n        code: 'VALIDATION_ERROR',\r\n        details: error.errors,\r\n      },\r\n    });\r\n  }\r\n\r\n  // Handle Stripe errors\r\n  if (error instanceof Error && error.name === 'StripeError') {\r\n    return res.status(400).json({\r\n      status: 'error',\r\n      error: {\r\n        message: error.message,\r\n        code: 'STRIPE_ERROR',\r\n      },\r\n    });\r\n  }\r\n\r\n  // Default error\r\n  return res.status(500).json({\r\n    status: 'error',\r\n    error: {\r\n      message: 'Internal server error',\r\n      code: 'INTERNAL_ERROR',\r\n    },\r\n  });\r\n};\r\n\r\nexport const withErrorHandler = (\r\n  handler: (req: VercelRequest, res: VercelResponse) => Promise<void>\r\n) => {\r\n  return async (req: VercelRequest, res: VercelResponse) => {\r\n    try {\r\n      setCommonHeaders(res);\r\n      // Handle preflight requests\r\n      if (req.method === 'OPTIONS') {\r\n        return res.status(204).end();\r\n      }\r\n      await handler(req, res);\r\n    } catch (error) {\r\n      errorHandler(error, req, res);\r\n    }\r\n  };\r\n}; "],
  "mappings": "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",
  "names": []
}
