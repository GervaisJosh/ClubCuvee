{
  "version": 3,
  "sources": ["create-customer-checkout.ts"],
  "sourcesContent": ["import { VercelRequest, VercelResponse } from '@vercel/node';\r\nimport { createClient } from '@supabase/supabase-js';\r\nimport Stripe from 'stripe';\r\n\r\n// Inline error handling (no external dependencies)\r\nclass APIError extends Error {\r\n  constructor(\r\n    public statusCode: number,\r\n    message: string,\r\n    public code?: string\r\n  ) {\r\n    super(message);\r\n    this.name = 'APIError';\r\n  }\r\n}\r\n\r\nconst setCommonHeaders = (res: VercelResponse) => {\r\n  res.setHeader('Content-Type', 'application/json');\r\n  res.setHeader('Access-Control-Allow-Origin', '*');\r\n  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');\r\n  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');\r\n};\r\n\r\nconst errorHandler = (\r\n  error: unknown,\r\n  req: VercelRequest,\r\n  res: VercelResponse\r\n) => {\r\n  console.error('API Error:', error);\r\n  setCommonHeaders(res);\r\n\r\n  if (req.method === 'OPTIONS') {\r\n    return res.status(204).end();\r\n  }\r\n\r\n  if (error instanceof APIError) {\r\n    return res.status(error.statusCode).json({\r\n      status: 'error',\r\n      error: {\r\n        message: error.message,\r\n        code: error.code,\r\n      },\r\n    });\r\n  }\r\n\r\n  return res.status(500).json({\r\n    status: 'error',\r\n    error: {\r\n      message: 'Internal server error',\r\n      code: 'INTERNAL_ERROR',\r\n    },\r\n  });\r\n};\r\n\r\nconst withErrorHandler = (\r\n  handler: (req: VercelRequest, res: VercelResponse) => Promise<void>\r\n) => {\r\n  return async (req: VercelRequest, res: VercelResponse) => {\r\n    try {\r\n      setCommonHeaders(res);\r\n      if (req.method === 'OPTIONS') {\r\n        return res.status(204).end();\r\n      }\r\n      await handler(req, res);\r\n    } catch (error) {\r\n      errorHandler(error, req, res);\r\n    }\r\n  };\r\n};\r\n\r\ninterface CreateCustomerCheckoutRequest {\r\n  token?: string;  // New token-based flow\r\n  business_id?: string;  // Legacy flow\r\n  tier_id?: string;  // Legacy flow  \r\n  customer_email?: string;  // Legacy flow\r\n  customer_name?: string;  // Legacy flow\r\n  customerData?: {  // New token-based flow\r\n    name: string;\r\n    email: string;\r\n    phone: string;\r\n    address: string;\r\n    city: string;\r\n    state: string;\r\n    zip_code: string;\r\n    wine_preferences: string;\r\n    dietary_restrictions: string;\r\n    special_requests: string;\r\n    selected_tier_id: string;\r\n  };\r\n}\r\n\r\nexport default withErrorHandler(async (req: VercelRequest, res: VercelResponse): Promise<void> => {\r\n  // Create Supabase admin client directly in the API (no external dependencies)\r\n  const supabaseAdmin = createClient(\r\n    process.env.SUPABASE_URL!,\r\n    process.env.SUPABASE_SERVICE_ROLE_KEY!,\r\n    {\r\n      auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false\r\n      }\r\n    }\r\n  );\r\n\r\n  // Initialize Stripe client\r\n  const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {\r\n    apiVersion: '2025-02-24.acacia',\r\n    typescript: true,\r\n  });\r\n  if (req.method !== 'POST') {\r\n    throw new APIError(405, 'Method not allowed', 'METHOD_NOT_ALLOWED');\r\n  }\r\n\r\n  const body: CreateCustomerCheckoutRequest = req.body;\r\n  const { token, business_id, tier_id, customer_email, customer_name, customerData } = body;\r\n\r\n  let business: any;\r\n  let tier: any;\r\n  let finalCustomerEmail: string;\r\n  let finalCustomerName: string;\r\n  let customerMetadata: any = {};\r\n\r\n  // TOKEN-BASED FLOW (new)\r\n  if (token && customerData) {\r\n    // Validate customer invitation token\r\n    const { data: invitation, error: invitationError } = await supabaseAdmin\r\n      .from('customer_invitations')\r\n      .select(`\r\n        *,\r\n        businesses!inner (\r\n          id,\r\n          name\r\n        )\r\n      `)\r\n      .eq('token', token)\r\n      .eq('status', 'pending')\r\n      .single();\r\n\r\n    if (invitationError || !invitation) {\r\n      throw new APIError(404, 'Invalid or expired customer invitation', 'INVALID_INVITATION');\r\n    }\r\n\r\n    // Check if invitation has expired\r\n    const now = new Date();\r\n    const expiryDate = new Date(invitation.expires_at);\r\n    if (now > expiryDate) {\r\n      throw new APIError(410, 'Customer invitation has expired', 'INVITATION_EXPIRED');\r\n    }\r\n\r\n    business = invitation.businesses;\r\n    finalCustomerEmail = customerData.email;\r\n    finalCustomerName = customerData.name;\r\n\r\n    // Get the selected tier\r\n    const { data: selectedTier, error: tierError } = await supabaseAdmin\r\n      .from('membership_tiers')\r\n      .select('*')\r\n      .eq('id', customerData.selected_tier_id)\r\n      .eq('restaurant_id', business.id)\r\n      .eq('is_active', true)\r\n      .single();\r\n\r\n    if (tierError || !selectedTier) {\r\n      throw new APIError(404, 'Selected membership tier not found', 'TIER_NOT_FOUND');\r\n    }\r\n\r\n    tier = selectedTier;\r\n\r\n    // Store customer data for post-checkout processing\r\n    customerMetadata = {\r\n      type: 'customer_membership',\r\n      token: token,\r\n      invitation_id: invitation.id,\r\n      name: customerData.name,\r\n      email: customerData.email,\r\n      phone: customerData.phone || '',\r\n      address: customerData.address,\r\n      city: customerData.city,\r\n      state: customerData.state,\r\n      zip_code: customerData.zip_code,\r\n      wine_preferences: customerData.wine_preferences || '',\r\n      dietary_restrictions: customerData.dietary_restrictions || '',\r\n      special_requests: customerData.special_requests || '',\r\n      business_id: business.id,\r\n      tier_id: tier.id\r\n    };\r\n  }\r\n  // LEGACY FLOW (existing)\r\n  else if (business_id && tier_id && customer_email) {\r\n    // Validate email format\r\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n    if (!emailRegex.test(customer_email)) {\r\n      throw new APIError(400, 'Invalid email format', 'INVALID_EMAIL');\r\n    }\r\n\r\n    // Get the business and tier details\r\n    const { data: businessData, error: businessError } = await supabaseAdmin\r\n      .from('businesses')\r\n      .select('id, name')\r\n      .eq('id', business_id)\r\n      .single();\r\n\r\n    if (businessError || !businessData) {\r\n      throw new APIError(404, 'Business not found', 'BUSINESS_NOT_FOUND');\r\n    }\r\n\r\n    // Get the membership tier details\r\n    const { data: tierData, error: tierError } = await supabaseAdmin\r\n      .from('membership_tiers')\r\n      .select('*')\r\n      .eq('id', tier_id)\r\n      .eq('business_id', business_id)\r\n      .eq('is_active', true)\r\n      .single();\r\n\r\n    if (tierError || !tierData) {\r\n      throw new APIError(404, 'Membership tier not found or not ready for signup', 'TIER_NOT_FOUND');\r\n    }\r\n\r\n    business = businessData;\r\n    tier = tierData;\r\n    finalCustomerEmail = customer_email;\r\n    finalCustomerName = customer_name || '';\r\n\r\n    customerMetadata = {\r\n      type: 'customer_membership',\r\n      business_id: business_id,\r\n      tier_id: tier_id,\r\n      customer_email: customer_email,\r\n      customer_name: customer_name || ''\r\n    };\r\n  } else {\r\n    throw new APIError(400, 'Invalid request: provide either token+customerData or business_id+tier_id+customer_email', 'INVALID_REQUEST');\r\n  }\r\n\r\n  if (!tier.stripe_price_id) {\r\n    throw new APIError(400, 'Membership tier is not configured for online signup', 'TIER_NOT_CONFIGURED');\r\n  }\r\n\r\n  // Determine success and cancel URLs based on flow type\r\n  const baseUrl = process.env.VERCEL_URL \r\n    ? `https://${process.env.VERCEL_URL}` \r\n    : process.env.BASE_URL || 'http://localhost:3000';\r\n\r\n  let successUrl: string;\r\n  let cancelUrl: string;\r\n\r\n  if (token && customerData) {\r\n    // New token-based flow\r\n    successUrl = `${baseUrl}/customer/welcome?session_id={CHECKOUT_SESSION_ID}&token=${token}`;\r\n    cancelUrl = `${baseUrl}/customer/join/${token}?canceled=true`;\r\n  } else {\r\n    // Legacy flow\r\n    successUrl = `${baseUrl}/join/${business_id}/success?session_id={CHECKOUT_SESSION_ID}`;\r\n    cancelUrl = `${baseUrl}/join/${business_id}?canceled=true`;\r\n  }\r\n\r\n  // Create Stripe checkout session\r\n  const session = await stripe.checkout.sessions.create({\r\n    mode: 'subscription',\r\n    payment_method_types: ['card'],\r\n    customer_email: finalCustomerEmail,\r\n    customer_creation: 'always',\r\n    line_items: [\r\n      {\r\n        price: tier.stripe_price_id,\r\n        quantity: 1,\r\n      },\r\n    ],\r\n    success_url: successUrl,\r\n    cancel_url: cancelUrl,\r\n    metadata: {\r\n      ...customerMetadata,\r\n      customer_name: finalCustomerName\r\n    },\r\n    subscription_data: {\r\n      metadata: {\r\n        ...customerMetadata,\r\n        customer_name: finalCustomerName\r\n      }\r\n    },\r\n    allow_promotion_codes: true, // Allow customers to use discount codes\r\n    billing_address_collection: 'auto'\r\n  });\r\n\r\n  res.status(200).json({\r\n    success: true,\r\n    data: {\r\n      sessionId: session.id,\r\n      checkoutUrl: session.url,\r\n      business: business,\r\n      tier: {\r\n        id: tier.id,\r\n        name: tier.name,\r\n        description: tier.description,\r\n        price_cents: tier.monthly_price_cents,\r\n        interval: 'month'\r\n      }\r\n    }\r\n  });\r\n});"],
  "mappings": "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",
  "names": ["Stripe"]
}
